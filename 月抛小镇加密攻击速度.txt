
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

task.spawn(function()
    local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local Humanoid = Character:WaitForChild("Humanoid")
    local Modules = ReplicatedStorage:WaitForChild("Modules")
    local ConfigModule = require(Modules:WaitForChild("Config"))

    local function getWeapons()
        local weapons = {}
        for _, tool in ipairs(LocalPlayer.Backpack:GetChildren()) do
            if tool:IsA("Tool") then
                table.insert(weapons, tool)
            end
        end
        for _, tool in ipairs(Character:GetChildren()) do
            if tool:IsA("Tool") then
                table.insert(weapons, tool)
            end
        end
        return weapons
    end

    for _, weapon in ipairs(getWeapons()) do
        local cfg = ConfigModule:GetConfig(weapon.Name, "Melees")
        if cfg then
            print("[BLACK WALL GUI] 修改武器配置:", weapon.Name)

            if cfg.Main then
                for _, v in pairs(cfg.Main) do
                    if type(v) == "table" then
                        v.DebounceTime = 0
                        v.ComboEndTime = math.huge
                        v.HitBoxStart = 0
                        v.HitBoxTime = 999
                        v.AnimSpeed = 5
                    end
                end
            end
            if cfg.Finish then
                cfg.Finish.DebounceTime = 0
                cfg.Finish.HitBoxStart = 0
                cfg.Finish.HitBoxTime = 999
            end

            if not weapon:GetAttribute("ZeroDelayBound") then
                local originalAttack
                for _, conn in pairs(getconnections(weapon.Activated)) do
                    if conn.Function then
                        originalAttack = conn.Function
                        conn:Disable()
                    end
                end

                if originalAttack then
                    weapon.Activated:Connect(function()
                        originalAttack()
                    end)
                    weapon:SetAttribute("ZeroDelayBound", true)
                end
            end
        end
    end

    if UserInputService.TouchEnabled then
        local success, guiClone = pcall(function()
            return ReplicatedStorage.Assets:WaitForChild("Guis"):WaitForChild("MeleeGui"):Clone()
        end)
        if success and guiClone then
            guiClone.Parent = LocalPlayer:WaitForChild("PlayerGui")
            if guiClone:FindFirstChild("Attack") then
                guiClone.Attack.MouseButton1Click:Connect(function()
                    for _, weapon in ipairs(getWeapons()) do
                        local cfg = ConfigModule:GetConfig(weapon.Name, "Melees")
                        if cfg then
                            for _, conn in pairs(getconnections(weapon.Activated)) do
                                if conn.Function then
                                    conn.Function()
                                end
                            end
                        end
                    end
                end)
            end
        end
    end

    print("[BLACK WALL GUI] snmwdd 以入侵悦")
end)
